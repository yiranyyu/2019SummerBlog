package com.mydg.controller;

import com.mydg.common.annotation.LogAnnotation;
import com.mydg.common.constant.Base;
import com.mydg.common.constant.ResultCode;
import com.mydg.common.result.Result;
import com.mydg.entity.User;
import com.mydg.oauth.OAuthSessionManager;
import com.mydg.service.UserService;
import org.apache.shiro.SecurityUtils;
import org.apache.shiro.authc.AuthenticationException;
import org.apache.shiro.authc.LockedAccountException;
import org.apache.shiro.authc.UnknownAccountException;
import org.apache.shiro.authc.UsernamePasswordToken;
import org.apache.shiro.subject.Subject;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import javax.servlet.http.HttpServletRequest;


@RestController
public class LoginController {

    @Autowired
    private UserService userService;

    @PostMapping("/login")
    @LogAnnotation(module = "登录", operation = "登录")
    public Result login(@RequestBody User user) {
        Result r = new Result();
        executeLogin(user.getAccount(), user.getPassword(), r);
        return r;
    }

    @PostMapping("/register")
    //@RequiresRoles(Base.ROLE_ADMIN)
    @LogAnnotation(module = "注册", operation = "注册")
    public Result register(@RequestBody User user) {

        Result r = new Result();

        User temp = userService.getUserByAccount(user.getAccount());
        if (null != temp) {
            r.setResultCode(ResultCode.USER_HAS_EXISTED);
            return r;
        }

        String account = user.getAccount();
        String password = user.getPassword();
        String avatar = "data:image/png;base64,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";
        user.setAvatar(avatar);
        // System.out.println(user.getAvatar());

        Long userId = userService.saveUser(user);

        if (userId > 0) {
            executeLogin(account, password, r);
        } else {
            r.setResultCode(ResultCode.USER_Register_ERROR);
        }
        return r;
    }


    private void executeLogin(String account, String password, Result r) {
        Subject subject = SecurityUtils.getSubject();
        UsernamePasswordToken token = new UsernamePasswordToken(account, password);

        try {
            subject.login(token);

            User currentUser = userService.getUserByAccount(account);
            subject.getSession().setAttribute(Base.CURRENT_USER, currentUser);

            r.setResultCode(ResultCode.SUCCESS);
            r.simple().put(OAuthSessionManager.OAUTH_TOKEN, subject.getSession().getId());
        } catch (UnknownAccountException e) {
            r.setResultCode(ResultCode.USER_NOT_EXIST);
        } catch (LockedAccountException e) {
            r.setResultCode(ResultCode.USER_ACCOUNT_FORBIDDEN);
        } catch (AuthenticationException e) {
            r.setResultCode(ResultCode.USER_LOGIN_ERROR);
        } catch (Exception e) {
            r.setResultCode(ResultCode.ERROR);
        }
    }

    @RequestMapping(value = "/handleLogin")
    public Result handleLogin(HttpServletRequest request) {
        String id = request.getHeader(OAuthSessionManager.OAUTH_TOKEN);
        System.out.println("超时登录。。。:" + id);
        return Result.error(ResultCode.SESSION_TIME_OUT);
    }


    @GetMapping("/logout")
    @LogAnnotation(module = "退出", operation = "退出")
    public Result logout() {

        Result r = new Result();
        Subject subject = SecurityUtils.getSubject();
        subject.logout();

        r.setResultCode(ResultCode.SUCCESS);
        return r;
    }
}
